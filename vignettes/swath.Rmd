---
title: "SWATH data analysis with xcms"
package: xcms
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{SWATH data analysis with xcms}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{xcms,msdata,BiocStyle}
  %\VignettePackage{xcms}
  %\VignetteKeywords{mass spectrometry, metabolomics}
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results = "asis" }
BiocStyle::markdown()
```

**Package**: `r Biocpkg("xcms")`<br />
**Authors**: Johannes Rainer, Michael Witting<br />
**Modified**: `r file.info("swath.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r init, message = FALSE, echo = FALSE, results = "hide" }
## Silently loading all packages
library(BiocStyle)
library(xcms)
library(pander)
register(SerialParam())
```

# Introduction

Metabolite identification is an important step in non-targeted metabolomics and
requires different steps. One involves the use of tandem mass spectrometry to
generate fragmentation spectra of detected metabolites, which are then compared
to fragmentation spectra of known metabolites. Different approches exist for the
generation of these fragmentation spectra, whereas the most used is data
dependent acquisition (DDA) also known as the top-n method. In this method the
top N most intense m/z values from a MS1 scan are selected for fragmentation in
the next N scans before the cycle starts again. This method allows to generate
clean MS2 fragmentation spectra on the fly during acquistion without the need
for further experiments, but suffers from poor coverage of the detected
metabolites (Only top N are fragmented).

Data independent approaches (DIA) like Bruker bbCID, Agilent AllIons or Waters
MSe don't use such a preselection, but rather fragment all detected molecules at
once. They are using alternating schemes with scan of low and high collision
energy to collect MS1 and MS2 data. Using this approach, there is no problem in
coverage, but the relation between the precursor and fragment masses is lost
leading to chimeric spectra. Sequential Window Acquisition of all Theoretical
Mass Spectra (or SWATH) combines both approaches through a middle-way
approach. There is no precursor selection and acquisition is independent of
acquired data, but rather than isolating all precusors at once defined windows
are used and scanned. This reduces the overlap of fragment spectra while still
keeping a high coverage.

This document showcases the analysis of a small SWATH experiment using
`r Biocpkg("xcms")`. The data files used are reversed-phase
LC-MS runs from the Agilent Pesticide mix obtained from a Sciex 6600 Triple ToF
operated in SWATH acquisition mode. For comparison a DDA file is included.

# Data import

SWATH data can be imported just like any other MS data using the `readMSData`
function from the `r Biocpkg("MSnbase")`. The resulting object will contain all
recorded MS1 and MS2 spectra. Below we read the example file.

```{r load-swath data, message = FALSE}
library(xcms)

swath_file <- system.file("TripleTOF-SWATH",
                          "PestMix1_SWATH.mzML",
                          package = "msdata")

swath_data <- readMSData(swath_file, mode = "onDisk")

```

First we can inspect the raw data and get information on the number of MS1 and
MS2 scans, as well as the used isolation windows. The number of MS level 1 and
MS level 2 spectra is listed below.

```{r table-mslevel}
table(msLevel(swath_data))
```

The isolation window definitions (SWATH pockets) were extracted from the mzML
files and are stored in the object's `fData` (providing additional annotations
for each individual spectrum). Below we inspect the respective information for
the first spectra. The actual lower and upper isolation window m/z can be
extracted with the `isolationWindowLowerMz` and `isolationWindowUpperMz`.

```{r fdata-isolationwindow}
head(fData(swath_data)[, c("isolationWindowTargetMZ",
                           "isolationWindowLowerOffset",
                           "isolationWindowUpperOffset",
                           "msLevel", "retentionTime")])

head(isolationWindowLowerMz(swath_data))
head(isolationWindowUpperMz(swath_data))

```

For the present data set we can use the *isolation window target m/z* to
identify the individual SWATH pockets. Below we list the number of spectra that
are recorded in each pocket/isolation window.

```{r}
table(isolationWindowTargetMz(swath_data))
```

# Chromatographic peak detection in MS1 and MS2 data

Next we perform the chromatographic peak detection in the MS level 1 data with
the `findChromPeaks` method. Below we define the settings for a *centWave*-based
peak detection and perform the analysis.

```{r find-chrom-peaks-ms1, message = FALSE}
cwp <- CentWaveParam(snthresh = 5, noise = 100, ppm = 10,
                     peakwidth = c(3, 30))
swath_data <- findChromPeaks(swath_data, param = cwp)

```

Next we perform a chromatographic peak detection in the MS level 2 data of each
isolation window. We use the `findChromPeaksIsolationWindow` function employing
the same peak detection algorithm and settings. The `isolationWindow` parameter
allows to specify which MS2 spectra belong to which isolation window. While the
default value for this parameter uses isolation windows defined by
`isolationWindowTargetMz`, it would also be possible to manually define the
isolation windows, e.g. if the corresponding information is not available in the
input mzML files.

```{r find-chrom-peaks-ms2, message = FALSE}
cwp <- CentWaveParam(snthresh = 3, noise = 10, ppm = 10,
                     peakwidth = c(3, 30))
swath_data <- findChromPeaksIsolationWindow(swath_data, param = cwp)
```

Peaks detected within isolation windows have been added to the `chromPeaks`
matrix. They can be identified by the value of the `"isolationWindow"` column in
the corresponding row of the `chromPeakData` peak annotations:

```{r}
chromPeakData(swath_data)
```

Below we count the number of chromatographic peaks within each isolation window.

```{r}
table(chromPeakData(swath_data)$isolationWindow)
```

# Reconstruction of MS2 spectra

Identifying the signal of the fragment ions for the precursor measured by each
MS1 chromatographic peak is a non-trivial task. The MS2 spectrum of the fragment
ion for each MS1 chromatographic peak has to be reconstructed from the available
MS2 signal (i.e. the chromatographic peaks identified in MS level 2). For SWATH
data, fragment ion signal should be present in the isolation window that
contains the m/z of the precursor ion and the chromatographic peak shape of the
MS2 chromatographic peaks of fragment ions of a specific precursor should have a
similar retention time and peak shape than the precursor's MS1 chromatographic
peak.

After detection of MS1 and MS2 chromatographic peaks has been performed, we can
reconstruct the MS2 spectra using the `reconstructChromPeakSpectra`
function. This function tries to reconstruct an MS2 spectrum for each MS1
chromatographic peak based on the following approach:

- Identify MS2 chromatographic peaks in the isolation window containing the m/z of
  the ion (the MS1 chromatographic peak) that have approximately the same
  retention time than the MS1 chromatographic peak (the accepted rt shift can be
  defined with the `diffRt` parameter).
- Correlate the peak shapes of the candidate MS2 chromatographic peaks with the
  shape of the MS1 peak retaining only MS2 chromatographic peaks for which the
  correlation is larger than a threshold (`minCor`).
- Reconstruct the MS2 spectrum using the m/z of all above selected MS2
  chromatographic peaks and their intensity; each MS2 chromatographic peak
  selected for an MS1 peak will thus represent one **mass peak** in the
  reconstructed spectrum.

To illustrate this process we perform the individual steps on the example of
Fluopicolide (exact mass 381.965430576 and m/z of [M+H]+ adduct 382.972706). As
a first step we extract the chromatographic peak for this ion.

```{r fluo-extract-peak}
fluo_mz <- 382.972706
fluo_ms1_peak <- chromPeaks(swath_data, mz = fluo_mz, ppm = 10)
fluo_ms1_peak
```

Next we identify all MS2 chromatographic peaks that were identified in the
isolation window containing the m/z of Fluopicolide. The information on the
isolation window in which a chromatographic peak was identified is available in
the `chromPeakData` (which contains arbitrary additional annotations to each
individual chromatographic peak).

```{r fluo-identify-ms2}
keep <- chromPeakData(swath_data)$isolationWindowLowerMz < fluo_mz &
        chromPeakData(swath_data)$isolationWindowUpperMz > fluo_mz
```

We also require the retention time of the MS2 chromatographic peaks to be
similar to the retention time of the MS1 peak and extract the corresponding peak information.

```{r fluo-check-rt}
keep <- keep & chromPeaks(swath_data)[, "rtmin"] < fluo_ms1_peak[, "rt"] &
    chromPeaks(swath_data)[, "rtmax"] > fluo_ms1_peak[, "rt"]

fluo_ms2_peak <- chromPeaks(swath_data)[which(keep), ]
```

In total `r sum(keep, na.rm = TRUE)` MS2 chromatographic peaks match all the
above condition. Next we extract their corresponding ion chromatograms, as well
as the ion chromatogram of the MS1 peak. Note that we extend the retention time
range by 1 seconds on both sides. In addition we have to filter the object
first by isolation window, keeping only spectra that were measured in that
specific window and to specify to extract the chromatographic data from MS2
spectra (with `msLevel = 2L`).

```{r fluo-eic-extract, warning = FALSE}
rtr <- fluo_ms1_peak[, c("rtmin", "rtmax")]
rtr[1] <- rtr[1] - 1
rtr[2] <- rtr[2] + 1
mzr <- fluo_ms1_peak[, c("mzmin", "mzmax")]
fluo_ms1_chr <- chromatogram(swath_data, rt = rtr, mz = mzr)

rtr <- fluo_ms2_peak[, c("rtmin", "rtmax")]
rtr[, 1] <- rtr[, 1] - 1
rtr[, 2] <- rtr[, 2] + 1
mzr <- fluo_ms2_peak[, c("mzmin", "mzmax")]
fluo_ms2_chr <- chromatogram(filterIsolationWindow(swath_data, mz = fluo_mz),
                             rt = rtr, mz = mzr, msLevel = 2L)
```

We can now plot the extracted ion chromatogram of the MS1 and the extracted MS2
data.

```{r fluo-eic-plot, fig.width = 10, fig.height = 5, fig.cap = "Extracted ion chromatograms for Fluopicolide from MS1 (blue) and potentially related signal in MS2 (grey)."}
plot(rtime(fluo_ms1_chr[1, 1]), intensity(fluo_ms1_chr[1, 1]),
     xlab = "retention time [s]", ylab = "intensity", pch = 16,
     ylim = c(0, 5000), col = "blue", type = "b", lwd = 2)
#' Add data from all MS2 peaks
tmp <- lapply(fluo_ms2_chr@.Data, function(z) points(rtime(z), intensity(z),
                                                     col = "#00000080",
                                                     type = "b", pch = 16))

```

Next we can calculate correlations between the peak shapes of each MS2
chromatogram with the MS1 peak. We perform the correlation below for one of the
MS2 chromatographic peaks. Note that the retention times will be different for
the MS2 and MS1 chromatographic data and before performing the correlation
analysis the data points between the two chromatograms have to be matched
(aligned) which is performed by the `correlate` function automatically. See the
help for the `align` method for more information on alignment options.

```{r fluo-cor}
correlate(fluo_ms2_chr[1, 1], fluo_ms1_chr[1, 1], align = "approx")
```

After identifying the MS2 chromatographic peaks with shapes of enough high
similarity to the MS1 chromatographic peaks, an MS2 spectrum could be
*reconstructed* based on the m/z and intensities of the MS2 chromatographic
peaks.

The `reconstructChromPeakSpectra` function performs the above analysis for each
individual MS1 chromatographic peak in a SWATH data set. Below we use this
function to reconstruct MS2 spectra for our example data.

```{r reconstruct-ms2, message = FALSE}
ms2_sps <- reconstructChromPeakSpectra(swath_data, minCor = 0.9)
ms2_sps
```

As a result we got a `Spectra` object of length equal to the number of MS1 peaks
in our data. Not for all MS1 signal a MS2 spectrum could be reconstructed
(elements with `peaksCount` equal to 0). For reconstructed spectra additional
annotations are available such as the IDs of the MS2 chromatographic peaks from
which the spectrum was reconstructed (`"ms2_peak_id"`) as well as the
correlation coefficient of their chromatographic peak shape with the precursor's
shape (`"ms2_peak_cor"`). Metadata column `"peak_id"` represents the identified
of the MS1 chromatographic peak.

We can now identify the reconstructed MS2 spectrum for Fluopicolide:

```{r fluo-reconstructed}
fluo_ms2 <- ms2_sps[mcols(ms2_sps)$peak_id == rownames(fluo_ms1_peak)]
```

As a reference for Fluopicolide we create below an MS2 spectrum with data from
Metlin (MID 72270, ESI-Q-ToF).

```{r fluo-metlin}
metlin_ms2 <- new("Spectrum2", precursorMz = 382.9727,
                  mz = c(193.9949, 172.9555, 144.9603, 108.9841, 74.0161),
                  intensity = c(3, 100, 36, 10, 5),
                  centroided = TRUE)
```

We next compare the two spectra with each other.

```{r fluo-mirrorplot, fig.cap = "Mirror plot comparing the reconstructed MS2 spectrum for Fluopicolide on top with the MS2 spectrum from Metlin (bottom)."}
plot(fluo_ms2[[1]], metlin_ms2)
```

And calculate their similarity based on the dot product.

```{r fluo-dotproduct}
compareSpectra(fluo_ms2[[1]], metlin_ms2, binSize = 0.05,
               fun = "dotproduct")
```

```{r dda, eval = FALSE, echo = FALSE}
## That chunk contains code to compare the SWATH with the DDA results.
dda_file <- system.file("TripleTOF-SWATH",
                        "PestMix1_DDA.mzML",
                        package = "msdata")

dda_data <- readMSData(dda_file, mode = "onDisk")
dda_data <- findChromPeaks(dda_data, param = cwp)

dda_sps <- chromPeakSpectra(dda_data, method = "all")

chromPeaks(dda_data, mz = fluopicolide_mz, ppm = 10)

dda_sps <- dda_sps[mcols(dda_sps)$peak_id == "CP065"]

tmp <- combineSpectra(dda_sps, minProp = 0.8,
                      method = "consensusSpectrum", ppm = 5)

plot(fluo_ms2[[1]], tmp[[1]])
plot(fluo_ms2[[1]], metlin_ms2)
plot(tmp[[1]], metlin_ms2)
plot(dda_sps[[3]], fluo_ms2[[1]])
plot(dda_sps[[1]], fluo_ms2[[1]])
```


# Session information

```{r sessionInfo}
sessionInfo()
```
