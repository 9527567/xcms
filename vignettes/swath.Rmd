---
title: "SWATH data analysis with xcms"
package: xcms
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{SWATH data analysis with xcms}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{xcms,RColorBrewer,faahKO,pander,magrittr,BiocStyle,pheatmap}
  %\VignettePackage{xcms}
  %\VignetteKeywords{mass spectrometry, metabolomics}
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results = "asis" }
BiocStyle::markdown()
```

**Package**: `r Biocpkg("xcms")`<br />
**Authors**: Johannes Rainer, Michael Wittingen<br />
**Modified**: `r file.info("swath.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r init, message = FALSE, echo = FALSE, results = "hide" }
## Silently loading all packages
library(BiocStyle)
library(xcms)
library(pander)
register(SerialParam())
```

# Introduction

This document showcases the analysis of a small SWATH experiment.

@michael TODO add some information about SWATH, the settings (sample?).

# Data import

SWATH data can be imported just like any other MS data using the `readMSData`
function from the `r Biocpkg("MSnbase")`. The resulting object will contain all
recorded MS1 and MS2 spectra. Below we read the example file.

```{r load-swath data, message = FALSE}
library(xcms)

#' That should go into the msdata package.
fl <- "/Users/jo/Projects/git/michaelwitting/metabolomics2018/data/PestMix1_SWATH.mzML"
swth <- readMSData(fl, mode = "onDisk")

```

```{r metabolites}
library(Risa)
ISAmtbls297 <- readISAtab(find.package("mtbls297"))
assay <- ISAmtbls297@assay.tabs[[1]]
msfiles <- paste(find.package("mtbls297"), "mzML",
                 assay@assay.file$"Derived Spectral Data File",
                 sep="/")

tomato <- readMSData(msfiles, mode = "onDisk")

table(msLevel(tomato))
head(isolationWindowLowerMz(tomato))
head(isolationWindowUpperMz(tomato))

head(fData(tomato)[, c("isolationWindowTargetMZ", "isolationWindowLowerOffset",
                       "isolationWindowUpperOffset", "msLevel", "retentionTime")])

cwp <- CentWaveParam(ppm = 25, peakwidth = c(10, 20), snthresh = 10,
                     prefilter = c(3, 100))
tomato <- findChromPeaks(tomato, cwp)
tomato <- findChromPeaksIsolationWindow(tomato, cwp)

chromPeakData(tomato)
table(chromPeakData(tomato)$isolationWindow)

```

The number of MS level 1 and MS level 2 spectra is listed below.

```{r table-mslevel}
table(msLevel(swth))
```

The isolation window definitions (SWATH pockets) were extracted from the mzML
files and are stored in the object's `fData` `data.frame`. Below we inspect the
respective information for the first spectra. The actual lower and upper
isolation window m/z can be extracted with the `isolationWindowLowerMz` and
`isolationWindowUpperMz`.

```{r fdata-isolationwindow}
head(isolationWindowLowerMz(swth))
head(isolationWindowUpperMz(swth))

head(fData(swth)[, c("isolationWindowTargetMZ", "isolationWindowLowerOffset",
                     "isolationWindowUpperOffset", "msLevel", "retentionTime")])
```

For the present data set we can use the *isolation window target m/z* to
identify the individual SWATH pockets. Below we list the number of spectra that
are recorded in each pocket/isolation window.

```{r}
table(isolationWindowTargetMz(swth))
```

# Chromatographic peak detection in MS1 and MS2 data

Next we perform the chromatographic peak detection in the MS level 1 data. This
can be done with the `findChromPeaks` method. Below we define the settings for a
*centWave*-based peak detection and perform the analysis.

```{r find-chrom-peaks-ms1, message = FALSE}
cwp <- CentWaveParam(snthresh = 5, noise = 100, ppm = 10, peakwidth = c(3, 30))
swth <- findChromPeaks(swth, param = cwp)

```

Next we perform a chromatographic peak detection in the MS level 2 data of each
isolation windows. We use the `findChromPeaksIsolationWindow` function employing
the same peak detection algorithm and settings. The `isolationWindow` parameter
allows to specify which MS2 spectra belong to which isolation window. We use the
default value for this parameter which uses isolation windows defined by
`isolationWindowTargetMz`, it is however also possible to manually define the
isolation windows, e.g. if the corresponding information is not available in the
input mzML files. Chromatographic peaks identified in each isolation window are
then added to the already identified chromatographic peaks and can be identified
by the column `"isolationWindow"` in `chromPeakData`.

```{r find-chrom-peaks-ms2, message = FALSE}
cwp <- CentWaveParam(snthresh = 3, noise = 10, ppm = 10, peakwidth = c(3, 30))
swth <- findChromPeaksIsolationWindow(swth, param = cwp)
```

Peaks identified within isolation windows have been added to the `chromPeaks`
matrix. They can be identified by the value of the `"isolationWindow"` column in
the corresponding row of the `chromPeakData` peak annotations:

```{r}
chromPeakData(swth)
```

The number of chromatographic peaks within each isolation window are can be
determined with the following call:

```{r}
table(chromPeakData(swth)$isolationWindow)
```

# Reconstruction of MS2 spectra

- For each MS1 chromatographic peak:
- find MS2 chromatographic peaks in the isolation window containing the m/z of
  the ion (the MS1 chromatographic peak) that have ~ the same retention time
  than the MS1 chromatographic peak. The accepted difference can be defined with
  the `diffRt` parameter.
- Extract and correlate the chromatograms of all matching MS2 chromatographic
  peaks to the extracted ion chromatogram of the MS1 chromatographic peak.
- Generate (reconstruct) the MS2 spectrum based on all MS2 chromatographic peaks
  for which the correlation to the MS1 extracted ion chromatogram is higher than
  `minCor`.
- Similar to the `chromPeakSpectra` the function returns a `Spectra` object.

```{r}
res <- xcms:::reconstructChromPeakSpectra(swth)
```


# Session information

```{r sessionInfo}
sessionInfo()
```
