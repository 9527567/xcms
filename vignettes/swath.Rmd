---
title: "SWATH data analysis with xcms"
package: xcms
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{SWATH data analysis with xcms}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{xcms,msdata,BiocStyle}
  %\VignettePackage{xcms}
  %\VignetteKeywords{mass spectrometry, metabolomics}
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results = "asis" }
BiocStyle::markdown()
```

**Package**: `r Biocpkg("xcms")`<br />
**Authors**: Johannes Rainer, Michael Witting<br />
**Modified**: `r file.info("swath.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r init, message = FALSE, echo = FALSE, results = "hide" }
## Silently loading all packages
library(BiocStyle)
library(xcms)
library(pander)
register(SerialParam())
```

# Introduction

This document showcases the analysis of a small SWATH experiment.

Metabolite identification is an important step in non-targeted metabolomics and
requires different steps. One involves the use of tandem mass spectrometry to
generate fragmentation spectra of detected metabolites, which are then compared
to fragmentation spectra of known metabolites. Different approches exist for the
generation of these fragmentation spectra, whereas the most used is data
dependent acquisition (DDA) also known as the top-n method. In this method the
top N most intense m/z values from a MS1 scan are selected for fragmentation in
the next N scans before the cycle starts again. This method allows to generate
clean MS2 fragmentation spectra on the fly during acquistion without the need
for further experiments, but suffers from poor coverage of the detected
metabolites (Only top N are fragmented).

Data independent approaches (DIA) like Bruker bbCID, Agilent AllIons or Waters
MSe don't use such a preselection, but rather fragment all detected molecules at
once. They are using alternating schemes with scan of low and high collision
energy to collect MS1 and MS2 data. Using this approach, there is no problem in
coverage, but the relation between the precursor and fragment masses is lost
leading to chimeric spectra. Sequential Window Acquisition of all Theoretical
Mass Spectra (or SWATH) combines both approaches through a middle-way
approach. There is no precursor selection and acquisition is independent of
acquired data, but rather than isolating all precusors at once defined windows
are used and scanned. This reduces the overlap of fragment spectra while still
keeping a high coverage. The data files used in this vignette are reversed-phase
LC-MS runs from the Agilent Pesticide mix obtained from a Sciex 6600 Triple ToF
operated in SWATH acquisition mode. For comparison a DDA file is included.

# Data import

SWATH data can be imported just like any other MS data using the `readMSData`
function from the `r Biocpkg("MSnbase")`. The resulting object will contain all
recorded MS1 and MS2 spectra. Below we read the example file.

```{r load-swath data, message = FALSE}
library(xcms)

swath_file <- system.file("TripleTOF-SWATH",
                          "PestMix1_SWATH.mzML",
                          package = "msdata")

swath_data <- readMSData(swath_file, mode = "onDisk")

```

First we can inspect the raw data and get information on the number of MS1 and
MS2 scans, as well as the used isolation windows. The number of MS level 1 and
MS level 2 spectra is listed below.

```{r table-mslevel}
table(msLevel(swath_data))
```

The isolation window definitions (SWATH pockets) were extracted from the mzML
files and are stored in the object's `fData` (providing additional annotations
for each individual spectrum). Below we inspect the respective information for
the first spectra. The actual lower and upper isolation window m/z can be
extracted with the `isolationWindowLowerMz` and `isolationWindowUpperMz`.

```{r fdata-isolationwindow}
head(fData(swath_data)[, c("isolationWindowTargetMZ",
                           "isolationWindowLowerOffset",
                           "isolationWindowUpperOffset",
                           "msLevel", "retentionTime")])

head(isolationWindowLowerMz(swath_data))
head(isolationWindowUpperMz(swath_data))

```

For the present data set we can use the *isolation window target m/z* to
identify the individual SWATH pockets. Below we list the number of spectra that
are recorded in each pocket/isolation window.

```{r}
table(isolationWindowTargetMz(swath_data))
```

# Chromatographic peak detection in MS1 and MS2 data

Next we perform the chromatographic peak detection in the MS level 1 data. This
can be done with the `findChromPeaks` method. Below we define the settings for a
*centWave*-based peak detection and perform the analysis.

```{r find-chrom-peaks-ms1, message = FALSE}
cwp <- CentWaveParam(snthresh = 5, noise = 100, ppm = 10, peakwidth = c(3, 30))
swath_data <- findChromPeaks(swath_data, param = cwp)

```

Next we perform a chromatographic peak detection in the MS level 2 data of each
isolation windows. We use the `findChromPeaksIsolationWindow` function employing
the same peak detection algorithm and settings. The `isolationWindow` parameter
allows to specify which MS2 spectra belong to which isolation window. We use the
default value for this parameter which uses isolation windows defined by
`isolationWindowTargetMz`, it is however also possible to manually define the
isolation windows, e.g. if the corresponding information is not available in the
input mzML files. Chromatographic peaks identified in each isolation window are
then added to the already identified chromatographic peaks and can be identified
by the column `"isolationWindow"` in `chromPeakData`.

```{r find-chrom-peaks-ms2, message = FALSE}
cwp <- CentWaveParam(snthresh = 3, noise = 10, ppm = 10, peakwidth = c(3, 30))
swath_data <- findChromPeaksIsolationWindow(swath_data, param = cwp)
```

Peaks identified within isolation windows have been added to the `chromPeaks`
matrix. They can be identified by the value of the `"isolationWindow"` column in
the corresponding row of the `chromPeakData` peak annotations:

```{r}
chromPeakData(swath_data)
```

The number of chromatographic peaks within each isolation window are can be
determined with the following call:

```{r}
table(chromPeakData(swath_data)$isolationWindow)
```

# Reconstruction of MS2 spectra

- For each MS1 chromatographic peak:
- find MS2 chromatographic peaks in the isolation window containing the m/z of
  the ion (the MS1 chromatographic peak) that have ~ the same retention time
  than the MS1 chromatographic peak. The accepted difference can be defined with
  the `diffRt` parameter.
- Extract and correlate the chromatograms of all matching MS2 chromatographic
  peaks to the extracted ion chromatogram of the MS1 chromatographic peak.
- Generate (reconstruct) the MS2 spectrum based on all MS2 chromatographic peaks
  for which the correlation to the MS1 extracted ion chromatogram is higher than
  `minCor`.
- Similar to the `chromPeakSpectra` the function returns a `Spectra` object.

```{r}
res <- xcms:::reconstructChromPeakSpectra(swath_data)
```

# Example:

```{r, eval = FALSE}
# Fluopicolide, exact mass = 381.965430576, [M+H]+ = 382.972706
eic <- chromatogram(xrms_ms1, aggregationFun = "max", mz = c(382.96, 382.98), rt = c(430,450))
plot(eic)
```

get peak of fluopicolide

```{r, eval = FALSE}
# add here on the chrom peak
```

Example spectrum (from Metlin)

```{r, eval = FALSE}
#example spectrum (taken from Metlin MID 72270, ESI-Q-ToF)
librarySpectrum <- new("Spectrum2",
                       precursorMz = 382.9727,
                       mz = c(193.9949, 172.9555, 144.9603, 108.9841, 74.0161),
                       intensity = c(3, 100, 36, 10, 5),
                       centroided = TRUE)
```

Matchin of spectra

```{r, eval = FALSE}
# make mirror plot of two spectra
plot(ms2spectrumMSnbase, librarySpectrum, xlim = c(50,400))
# calculate dot product
compareSpectra(ms2spectrumMSnbase, librarySpectrum, binSize = 0.05, fun = "dotproduct")
```


# Session information

```{r sessionInfo}
sessionInfo()
```
